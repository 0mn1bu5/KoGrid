(function(window,undefined){function getElementsByAttribute(oElm,strTagName,strAttributeName,strAttributeValue,contains){if(!oElm)return false;var arrElements=(strTagName=="*"&&oElm.all)?oElm.all:oElm.getElementsByTagName(strTagName);var arrReturnElements=new Array();var oAttributeValue=(typeof strAttributeValue!="undefined")?new RegExp("(^|\\s)"+strAttributeValue+"(\\s|$)"):null;var oCurrent;var oAttribute;for(var i=0;i<arrElements.length;i++){oCurrent=arrElements[i];oAttribute=oCurrent.getAttribute&&oCurrent.getAttribute(strAttributeName);if(typeof oAttribute=="string"&&oAttribute.length>0){if(typeof strAttributeValue=="undefined"||(contains?(oAttribute.indexOf(strAttributeValue)!=-1):(oAttributeValue&&oAttributeValue.test(oAttribute)))){arrReturnElements.push(oCurrent);}}}
return arrReturnElements;}
var dba=getElementsByAttribute(window.document,"*","data-bind","koGrid",true);var len=dba.length,i=0;for(;i<len;i++){if(dba[i]!==undefined){if(dba.indexOf("keydown")==-1){var cas=$(dba)[i].getAttribute("data-bind")
$(dba[i]).attr("data-bind","event: { keydown: ko.kgMoveSelection }, "+cas);}}}
ko.kgMoveSelection=function(sender,evt){var offset,grid,charCode=(evt.which)?evt.which:event.keyCode;switch(charCode){case 38:offset=-1;break;case 40:offset=1;break;default:return true;}
if(navigator.appName=='Microsoft Internet Explorer'){grid=window['kg'].gridManager.getGrid($(document.activeElement).closest(".kgGrid")[0]);}else{grid=window['kg'].gridManager.getGrid(document.activeElement);}
if(grid!=null&&grid!=undefined){if(grid.config.selectedItems()!=undefined){var items=grid.finalData();var n=items.length;var index=items.indexOf(grid.config.lastClickedRow().entity())+offset;if(index>=0&&index<n){var selected=items[index];grid.selectionManager.changeSelection(selected.myRowEntity,evt);var itemtoView=document.getElementsByClassName("kgSelected");if(!Element.prototype.scrollIntoViewIfNeeded){itemtoView[0].scrollIntoView(false);}else{itemtoView[0].scrollIntoViewIfNeeded();}}}}};﻿
var kg=window['kg']={};kg.templates={};﻿
var SELECTED_PROP='__kg_selected__';var GRID_TEMPLATE='koGridTmpl';﻿kg.labels={};﻿var utils={forEach:function(arr,action){var len=arr.length,i=0;for(;i<len;i++){if(arr[i]!==undefined){action(arr[i],i);}}},forIn:function(obj,action){var prop;for(prop in obj){if(obj.hasOwnProperty(prop)){action(obj[prop],prop);}}}};utils.newId=(function(){var seedId=new Date().getTime();return function(){return seedId+=1;};}());utils.StringBuilder=function(){var strArr=[];this.append=function(str,data){var len=arguments.length,intMatch=0,strMatch='{0}',i=1;if(len>1){while(i<len){while(str.indexOf(strMatch)!==-1){str=str.replace(strMatch,arguments[i]);}
i++;intMatch=i-1;strMatch="{"+intMatch.toString()+"}";}}
strArr.push(str);};this.toString=function(){var separator=arguments[0];if(separator!==null&&separator!==undefined){return strArr.join(separator);}else{return strArr.join("");}};};kg.utils=utils;﻿kg.templates.defaultGridInnerTemplate=function(){return'<div class="kgTopPanel" data-bind="kgSize: $data.headerDim">'+'<div class="kgHeaderContainer" data-bind="kgSize: $data.headerDim">'+'<div class="kgHeaderScroller" data-bind="kgHeaderRow: $data, kgSize: $data.headerScrollerDim">'+'</div>'+'</div>'+'</div>'+'<div class="kgViewport" data-bind="kgSize: $data.viewportDim">'+'<div class="kgCanvas" data-bind="kgRows: $data.rows, style: { height: $data.canvasHeight }" style="position: relative">'+'</div>'+'</div>'+'<div class="kgFooterPanel" data-bind="kgFooter: $data, kgSize: $data.footerDim">'+'</div>';};﻿﻿kg.templates.generateHeaderTemplate=function(options){var b=new kg.utils.StringBuilder(),cols=options.columns,showFilter=options.showFilter;utils.forEach(cols,function(col,i){if(col.field==='__kg_selected__'){b.append('<div class="kgSelectionCell" data-bind="kgHeader: { value: \'{0}\' }, css: { \'kgNoSort\': {1} }">',col.field,!col.allowSort);b.append('  <input type="checkbox" data-bind="checked: $parent.toggleSelectAll"/>');b.append('</div>');}else if(col.field==='rowIndex'&&showFilter){b.append('<div data-bind="kgHeader: { value: \'{0}\' }, css: { \'kgNoSort\': {1} }">',col.field,!col.allowSort);b.append('      <div title="Filter Results" class="kgFilterBtn openBtn" data-bind="visible: !$data.filterVisible(), click: $parent.showFilter_Click"></div>');b.append('      <div title="Close" class="kgFilterBtn closeBtn" data-bind="visible: $data.filterVisible, click: $parent.showFilter_Click"></div>');b.append('      <div title="Clear Filters" class="kgFilterBtn clearBtn" data-bind="visible: $data.filterVisible, click: $parent.clearFilter_Click"></div>');b.append('</div>');}else{b.append('<div data-bind="kgHeader: { value: \'{0}\' }, css: { \'kgNoSort\': {1} }">',col.field,!col.allowSort);b.append('</div>');}});return b.toString();};﻿kg.templates.defaultHeaderCellTemplate=function(){var b=new kg.utils.StringBuilder();b.append('<div data-bind="click: $data.sort, css: { \'kgSorted\': !$data.noSortVisible() }">');b.append('  <span data-bind="text: $data.displayName"></span>');b.append('  <img class="kgSortImg" data-bind="visible: $data.allowSort() && $data.noSortVisible()" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAYAAAD+WDajAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAEFJREFUKFNjYICC+vp6YyDeDcSCMDEwDRRQAuK7QPwfpAAuiSYBkkQoAHLOQAVgEjB6FYrxGBy8OvHaide1+PwJAMBIWUlZ9vlNAAAAAElFTkSuQmCC"/>');b.append('  <img class="kgSortImg" data-bind="visible: $data.sortAscVisible" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAYAAAD+WDajAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAPElEQVQoU2NggIL6+npjIN4NxIIwMTANFFAC4rtA/B+kAC6JJgGSRCgAcs5ABWASMHoVw////3HigZAEACKmlTwMfriZAAAAAElFTkSuQmCC"/>');b.append('  <img class="kgSortImg" data-bind="visible: $data.sortDescVisible" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAYAAAD+WDajAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAPUlEQVQoU2P4//8/Ay6MUwKkgQJJBnygvr7+DBD/x4JXMQAFlYD4LprkbriBaAoQEjAVQAXGQLwbiAVhYgD6kIBR+tr9IgAAAABJRU5ErkJggg=="/>');b.append('</div>');b.append('<div data-bind="visible: $data._filterVisible">');b.append('  <input type="text" data-bind="value: $data.column.filter, valueUpdate: \'afterkeydown\'" style="width: 80%" tabindex="1" />');b.append('</div>');return b.toString();};﻿kg.templates.generateRowTemplate=function(options){var b=new kg.utils.StringBuilder(),cols=options.columns;b.append('<div data-bind="kgRow: $data, click: $data.toggleSelected, css: { \'kgSelected\': $data.selected }">');utils.forEach(cols,function(col,i){if(col.field==='__kg_selected__'){b.append('<div class="kgSelectionCell" data-bind="kgCell: { value: \'{0}\' } ">',col.field);b.append('  <input type="checkbox" data-bind="checked: $data.selected" />');b.append('</div>');}
else if(col.field==='rowIndex'){b.append('<div class="kgRowIndexCell" data-bind="kgCell: { value: \'{0}\' } "></div>',col.field);}
else if(col.hasCellTemplate){var tmpl=kg.templateManager.getTemplateText(col.cellTemplate);var replacer="{ value: '"+col.field+"' }";tmpl=tmpl.replace(/\$cellClass/g,col.cellClass||'kgEmpty');tmpl=tmpl.replace(/\$cellValue/g,"$data."+col.field);tmpl=tmpl.replace(/\$cell/g,replacer);b.append(tmpl);}
else{b.append('  <div class="{0}"  data-bind="kgCell: { value: \'{1}\' } "></div>',col.cellClass||'kgEmpty',col.field);}});b.append('</div>');return b.toString();};﻿kg.templates.defaultFooterTemplate=function(){return'<div class="kgTotalSelectContainer" data-bind="visible: footerVisible">'+'<div class="kgFooterTotalItems">'+'<span class="kgLabel">Total Items:</span> <span data-bind="text: maxRows"></span>'+'</div>'+'<div class="kgFooterSelectedItems" data-bind="visible: selectedItems().length > 1">'+'<span class="kgLabel">Selected Items:</span> <span data-bind="text: selectedItemCount"></span>'+'</div>'+'</div>'+'<div class="kgPagerContainer" data-bind="visible: pagerVisible() && footerVisible(), css: {\'kgNoMultiSelect\': selectedItems().length > 1}">'+'<div style="float: right;">'+'<div class="kgRowCountPicker">'+'<span class="kgLabel">Rows:</span>'+'<select data-bind="options: pageSizes, value: selectedPageSize">'+'</select>'+'</div>'+'<div class="kgPagerControl">'+'<input class="kgPagerFirst" type="button" data-bind="click: pageToFirst, enable: canPageBackward" title="First Page"/>'+'<input class="kgPagerPrev" type="button"  data-bind="click: pageBackward, enable: canPageBackward" title="Previous Page"/>'+'<input class="kgPagerCurrent" type="text" data-bind="value: protectedCurrentPage, enable: maxPages() > 1" />'+'<input class="kgPagerNext" type="button"  data-bind="click: pageForward, enable: canPageForward" title="Next Page"/>'+'<input class="kgPagerLast" type="button"  data-bind="click: pageToLast, enable: canPageForward" title="Last Page"/>'+'</div>'+'</div>'+'</div>';};﻿kg.templates.defaultFooterTemplate=function(){return'<div class="kgTotalSelectContainer" data-bind="visible: footerVisible">'+'<div class="kgFooterTotalItems">'+'<span class="kgLabel">Total Items:</span> <span data-bind="text: maxRows"></span>'+'</div>'+'<div class="kgFooterSelectedItems">'+'<span class="kgLabel">Selected Items:</span> <span data-bind="text: selectedItemCount"></span>'+'</div>'+'</div>'+'<div class="kgPagerContainer" data-bind="visible: pagerVisible() && footerVisible()">'+'<div style="float: right;">'+'<div class="kgRowCountPicker"">'+'<span class="kgLabel">Rows:</span>'+'<select data-bind="options: pageSizes, value: selectedPageSize">'+'</select>'+'</div>'+'<div class="kgPagerControl" style="float: left; min-width: 135px;">'+'<input class="kgPagerFirst" type="button" data-bind="click: pageToFirst, enable: canPageBackward" title="First Page"/>'+'<input class="kgPagerPrev" type="button"  data-bind="click: pageBackward, enable: canPageBackward" title="Previous Page"/>'+'<input class="kgPagerCurrent" type="text" data-bind="value: protectedCurrentPage, enable: maxPages() > 1" />'+'<input class="kgPagerNext" type="button"  data-bind="click: pageForward, enable: canPageForward" title="Next Page"/>'+'<input class="kgPagerLast" type="button"  data-bind="click: pageToLast, enable: canPageForward" title="Last Page"/>'+'</div>'+'</div>'+'</div>';};﻿kg.templateManager=(new function(){var self=this;self.templateExists=function(tmplId){var el=document.getElementById(tmplId);return(el!==undefined&&el!==null);};self.addTemplate=function(templateText,tmplId){var tmpl=document.createElement("SCRIPT");tmpl.type="text/html";tmpl.id=tmplId;tmpl.text=templateText;document.body.appendChild(tmpl);};this.removeTemplate=function(tmplId){var element=document.getElementById(tmplId);if(element)element.parentNode.removeChild(element);};this.addTemplateSafe=function(tmplId,templateTextAccessor){if(!self.templateExists(tmplId)){self.addTemplate(templateTextAccessor(),tmplId);}};this.ensureGridTemplates=function(options){var defaults={rowTemplate:'',headerTemplate:'',headerCellTemplate:'',footerTemplate:'',columns:null,showFilter:true},config=$.extend(defaults,options);self.addTemplateSafe(GRID_TEMPLATE,kg.templates.defaultGridInnerTemplate);if(config.headerTemplate){self.addTemplateSafe(config.headerTemplate,function(){return kg.templates.generateHeaderTemplate(config);});}
if(config.headerCellTemplate){self.addTemplateSafe(config.headerCellTemplate,kg.templates.defaultHeaderCellTemplate);}
if(config.rowTemplate){self.addTemplateSafe(config.rowTemplate,function(){return kg.templates.generateRowTemplate(config);});}
if(config.footerTemplate){self.addTemplateSafe(config.footerTemplate,kg.templates.defaultFooterTemplate);}};this.getTemplateText=function(tmplId){if(!self.templateExists(tmplId)){return"";}else{var el=document.getElementById(tmplId);return el.text;}};}());﻿kg.Dimension=function(options){this.innerHeight=null;this.innerWidth=null;this.outerHeight=null;this.outerWidth=null;this.widthDiff=null;this.heightDiff=null;this.autoFitHeight=false;this.autoFitWidth=false;$.extend(this,options);};﻿kg.Cell=function(col){this.data='';this.column=col;this.row=null;};﻿kg.Column=function(colDef){this.width=ko.observable(0);this.field=colDef.field;if(colDef.displayName===undefined||colDef.displayName===null){colDef.displayName=colDef.field;}
this.displayName=colDef.displayName;this.colIndex=0;this.isVisible=ko.observable(false);if(colDef.sortable===undefined||colDef.sortable===null){colDef.sortable=true;}
if(colDef.resizable===undefined||colDef.resizable===null){colDef.resizable=true;}
if(colDef.filterable===undefined||colDef.filterable===null){colDef.filterable=true;}
this.allowSort=colDef.sortable;this.allowResize=colDef.resizable;this.allowFilter=colDef.filterable;this.sortDirection=ko.observable("");this.filter=ko.observable();this.cellTemplate=colDef.cellTemplate;this.hasCellTemplate=(this.cellTemplate?true:false);this.cellClass=colDef.cellClass;this.headerClass=colDef.headerClass;this.headerTemplate=colDef.headerTemplate
this.hasHeaderTemplate=(this.headerTemplate?true:false);if(!colDef.width){colDef.width=this.displayName.length*kg.domUtility.letterW;colDef.width+=30;}
this.width(colDef.width);};﻿kg.ColumnCollection=function(){var obs=ko.observableArray([]);ko.utils.extend(obs,kg.ColumnCollection.fn);return obs;};kg.ColumnCollection.fn={};﻿
kg.Row=function(entity,config,selectionManager){var self=this,KEY='__kg_selected__',canSelectRows=config.canSelectRows;this.selectedItems=config.selectedItems;this.entity=ko.isObservable(entity)?entity:ko.observable(entity);this.selectionManager=selectionManager;if(this.entity()['__kg_selected__']===undefined){this.entity()['__kg_selected__']=ko.observable(false);}
this.selected=ko.dependentObservable({read:function(){if(!canSelectRows){return false;}
var val=self.entity()['__kg_selected__']();return val;},write:function(val){if(!canSelectRows){return true;}
self.entity()['__kg_selected__'](val);self.onSelectionChanged();}});this.toggleSelected=function(data,event){if(!canSelectRows){return true;}
var element=event.target;if(element.type=="checkbox"&&element.parentElement.className.indexOf("kgSelectionCell"!==-1)){return true;}
if(config.selectWithCheckboxOnly&&element.type!="checkbox"){return true;}else{self.selectionManager.changeSelection(self,event);}};this.toggle=function(item){if(item.selected()){item.selected(false);self.selectedItems.remove(item.entity());}else{item.selected(true);if(self.selectedItems.indexOf(item.entity())===-1){self.selectedItems.push(item.entity());}}};this.cells=ko.observableArray([]);this.cellMap={};this.rowIndex=0;this.offsetTop=0;this.rowKey=utils.newId();this.rowDisplayIndex=0;this.onSelectionChanged=function(){};(function(){utils.forIn(entity,function(prop,propName){self[propName]=prop;});}());};﻿kg.Range=function(bottom,top){this.topRow=top;this.bottomRow=bottom;};﻿kg.CellFactory=function(cols){var colCache=cols,len=colCache.length;this.buildRowCells=function(row){var cell,cells=[],col,i=0;for(;i<len;i++){col=colCache[i];cell=new kg.Cell(col);cell.row=row;cell.data=row.entity()[col.field];cells.push(cell);row.cellMap[col.field]=cell;}
row.cells(cells);return row;};};﻿kg.HeaderCell=function(col){var self=this;this.colIndex=0;this.displayName=col.displayName;this.field=col.field;this.column=col;this.headerClass=col.headerClass;this.headerTemplate=col.headerTemplate;this.hasHeaderTemplate=col.hasHeaderTemplate;this.allowSort=ko.observable(col.allowSort);this.allowFilter=col.allowFilter;this.width=ko.computed(function(){return col.width();});this.filter=ko.computed({read:function(){return self.column.filter();},write:function(val){self.column.filter(val);}});this.filterVisible=ko.observable(false);this._filterVisible=ko.computed({read:function(){return self.allowFilter;},write:function(val){self.filterVisible(val);}});this.sortAscVisible=ko.computed(function(){return self.column.sortDirection()==="asc";});this.sortDescVisible=ko.computed(function(){return self.column.sortDirection()==="desc";});this.noSortVisible=ko.computed(function(){var sortDir=self.column.sortDirection();return sortDir!=="asc"&&sortDir!=="desc";});this.sort=function(){if(!self.allowSort()){return;}
var dir=self.column.sortDirection()==="asc"?"desc":"asc";self.column.sortDirection(dir);};this.filterHasFocus=ko.observable(false);};﻿kg.HeaderRow=function(){this.headerCells=[];this.height;this.headerCellMap={};this.filterVisible=ko.observable(false);};﻿kg.RowManager=function(grid){var self=this,prevMaxRows=0,prevMinRows=0,dataChanged=true,currentPage=grid.config.currentPage,pageSize=grid.config.pageSize,prevRenderedRange=new kg.Range(0,1),prevViewableRange=new kg.Range(0,1),internalRenderedRange=ko.observable(prevRenderedRange);this.rowCache=[];this.dataSource=grid.finalData;this.dataSource.subscribe(function(){dataChanged=true;self.rowCache=[];});this.minViewportRows=grid.minRowsToRender;this.excessRows=8;this.rowHeight=grid.config.rowHeight;this.cellFactory=new kg.CellFactory(grid.columns());this.viewableRange=ko.observable(prevViewableRange);this.renderedRange=ko.observable(prevRenderedRange);this.rows=ko.observableArray([]);this.rowSubscriptions={};this.buildRowFromEntity=function(entity,rowIndex,pagingOffset){var row=self.rowCache[rowIndex];if(!row){row=new kg.Row(entity,grid.config,grid.selectionManager);row.rowIndex=rowIndex+1;row.rowDisplayIndex=row.rowIndex+pagingOffset;row.offsetTop=self.rowHeight*rowIndex;self.cellFactory.buildRowCells(row);self.rowCache[rowIndex]=row;}
return row;};this.renderedRange.subscribe(function(rg){var rowArr=[],row,pagingOffset=(pageSize()*(currentPage()-1)),dataArr=self.dataSource().slice(rg.bottomRow,rg.topRow);utils.forEach(dataArr,function(item,i){row=self.buildRowFromEntity(item,rg.bottomRow+i,pagingOffset);item.myRowEntity=row;rowArr.push(row);row=null;});self.rows(rowArr);});this.calcRenderedRange=function(){var rg=self.viewableRange(),minRows=self.minViewportRows(),maxRows=self.dataSource().length,isDif=false,newRg;if(rg){isDif=(rg.bottomRow!==prevViewableRange.bottomRow||rg.topRow!==prevViewableRange.topRow||dataChanged)
if(!isDif&&prevMaxRows!==maxRows){isDif=true;rg=new kg.Range(prevViewableRange.bottomRow,prevViewableRange.topRow);}
if(!isDif&&prevMinRows!==minRows){isDif=true;rg=new kg.Range(prevViewableRange.bottomRow,prevViewableRange.topRow);}
if(isDif){rg.topRow=rg.bottomRow+minRows;prevViewableRange=rg;newRg=new kg.Range(rg.bottomRow,rg.topRow);newRg.bottomRow=Math.max(0,rg.bottomRow-self.excessRows);newRg.topRow=Math.min(maxRows,rg.topRow+self.excessRows);prevMaxRows=maxRows;prevMinRows=minRows;if(prevRenderedRange.topRow!==newRg.topRow||prevRenderedRange.bottomRow!==newRg.bottomRow||dataChanged){dataChanged=false;prevRenderedRange=newRg;self.renderedRange(newRg);}}}else{self.renderedRange(new kg.Range(0,0));}};self.viewableRange.subscribe(self.calcRenderedRange);self.minViewportRows.subscribe(self.calcRenderedRange);self.dataSource.subscribe(self.calcRenderedRange);};﻿kg.Footer=function(grid){var self=this;this.maxRows;if(grid.config.totalServerItems()!==null&&grid.config.totalServerItems()!==undefined){this.maxRows=grid.config.totalServerItems;}else{this.maxRows=grid.maxRows;}
this.isMultiSelect=ko.observable(grid.config.canSelectRows&&grid.config.isMultiSelect);this.selectedItemCount=grid.selectedItemCount;this.footerVisible=grid.config.footerVisible;this.pagerVisible=ko.observable(grid.config.enablePaging);this.selectedPageSize=grid.config.pageSize;this.pageSizes=ko.observableArray(grid.config.pageSizes);this.currentPage=grid.config.currentPage;this.maxPages=ko.computed(function(){var maxCnt=self.maxRows()||1,pageSize=self.selectedPageSize();return Math.ceil(maxCnt/pageSize);});this.protectedCurrentPage=ko.computed({read:function(){return self.currentPage();},write:function(page){if(page&&page<=self.maxPages()&&page>0){self.currentPage(page);}},owner:self});this.pageForward=function(){var page=self.currentPage();self.currentPage(Math.min(page+1,self.maxPages()));}
this.pageBackward=function(){var page=self.currentPage();self.currentPage(Math.max(page-1,1));};this.pageToFirst=function(){self.currentPage(1);};this.pageToLast=function(){var maxPages=self.maxPages();self.currentPage(maxPages);};this.canPageForward=ko.computed(function(){var curPage=self.currentPage();var maxPages=self.maxPages();return curPage<maxPages;});this.canPageBackward=ko.computed(function(){var curPage=self.currentPage();return curPage>1;});};﻿kg.FilterManager=function(options){var self=this,wildcard=options.filterWildcard||"*",includeDestroyed=options.includeDestroyed||false,regExCache={},initPhase=0,internalFilteredData=ko.observableArray([]);if(wildcard==='*'||wildcard==='%'){}else{throw new Error("You can only declare a percent sign (%) or an asterisk (*) as a wildcard character");}
var filterDestroyed=function(arr){return ko.utils.arrayFilter(arr,function(item){return(item['_destroy']===true?false:true);});};this.filterInfo=options.filterInfo||ko.observable();this.data=options.data;this.filteredData=ko.computed(function(){var data=internalFilteredData();if(initPhase>0){return data;}else{return filterDestroyed(self.data());}});var isEmpty=function(data){return(data===null||data===undefined||data==='');};var matchString=function(itemStr,filterStr){var regex=regExCache[filterStr];if(!regex){var replacer="";filterStr=filterStr.replace(/\\/g,"\\");if(wildcard==="*"){replacer=/\*/g;}else{replacer=/\%/g;}
var regexStr=filterStr.replace(replacer,"[^\']*");if(regexStr!=="*"){regexStr="^"+regexStr;}
try{regex=new RegExp(regexStr,"gi");}
catch(e){regex=/.*/gi;}
regExCache[filterStr]=regex;}
return itemStr.match(regex);};var filterData=function(){var filterInfo=self.filterInfo(),data=self.data(),keepRow=false,match=true,newArr=[],field,itemData,itemDataStr,filterStr;data=filterDestroyed(data);if(!filterInfo||$.isEmptyObject(filterInfo)||options.useExternalFiltering){internalFilteredData(data);return;}
regExCache={};newArr=ko.utils.arrayFilter(data,function(item){var propPath,i;for(field in filterInfo){if(filterInfo.hasOwnProperty(field)){propPath=field.split(".");itemData=item;for(i=0;i<propPath.length&&itemData!==undefined&&itemData!==null;i++){itemData=ko.utils.unwrapObservable(itemData[propPath[i]]);}
filterStr=filterInfo[field];if(!isEmpty(filterStr)&&filterStr!==wildcard){if(isEmpty(itemData)){match=false;}else if(typeof itemData==="string"){match=matchString(itemData,filterStr);}else{itemDataStr=itemData.toString();match=matchString(itemDataStr,filterStr);}}}
if(keepRow&&!match){keepRow=false;}else if(!keepRow&&match){keepRow=true;}
if(!match){break;}}
filterStr=null;itemData=null;itemDataStr=null;match=true;return keepRow;});internalFilteredData(newArr);};this.data.subscribe(filterData);this.filterInfo.subscribe(filterData);this.createFilterChangeCallback=function(col){return function(newFilterVal){var info=self.filterInfo();if(!info&&!newFilterVal){return;}
if(!info){info={};}
if((newFilterVal===null||newFilterVal===undefined||newFilterVal==="")&&info[col.field]){delete info[col.field];}else if(newFilterVal!==null&&newFilterVal!==undefined){info[col.field]=newFilterVal;}
self.filterInfo(info);options.currentPage(1);};};initPhase=1;};﻿﻿kg.SortManager=function(options){var self=this,colSortFnCache={},dateRE=/^(\d\d?)[\/\.-](\d\d?)[\/\.-]((\d\d)?\d\d)$/,ASC="asc",DESC="desc",prevSortInfo={},dataSource=options.data,initPhase=0,internalSortedData=ko.observableArray([]);this.isEmpty=function(val){return(val===null||val===undefined||val==='');};this.sortInfo=options.sortInfo||ko.observable();this.sortedData=ko.computed(function(){var sortData=internalSortedData();if(initPhase>0){return sortData;}else{return dataSource();}});this.guessSortFn=function(item){var sortFn,itemStr,itemType,dateParts,month,day;if(item===undefined||item===null||item===''){return null;}
itemType=typeof(item);switch(itemType){case"number":sortFn=self.sortNumber;break;case"boolean":sortFn=self.sortBool;break;}
if(sortFn){return sortFn;}
if(Object.prototype.toString.call(item)==='[object Date]'){return self.sortDate;}
if(itemType!=="string"){return null;}
if(item.match(/^-?[£$¤]?[\d,.]+%?$/)){return self.sortNumberStr;}
dateParts=item.match(dateRE)
if(dateParts){month=parseInt(dateParts[1]);day=parseInt(dateParts[2]);if(month>12){return self.sortDDMMStr;}else if(day>12){return self.sortMMDDStr;}else{return self.sortMMDDStr;}}
return self.sortAlpha;};this.sortNumber=function(a,b){return a-b;};this.sortNumberStr=function(a,b){var numA,numB,badA=false,badB=false;numA=parseFloat(a.replace(/[^0-9.-]/g,''));if(isNaN(numA)){badA=true;}
numB=parseFloat(b.replace(/[^0-9.-]/g,''));if(isNaN(numB)){badB=true;}
if(badA&&badB){return 0;}
if(badA){return 1;}
if(badB){return-1;}
return numA-numB;};this.sortAlpha=function(a,b){var strA=a.toUpperCase(),strB=b.toUpperCase();return strA==strB?0:(strA<strB?-1:1);};this.sortDate=function(a,b){var timeA=a.getTime(),timeB=b.getTime();return timeA==timeB?0:(timeA<timeB?-1:1);};this.sortBool=function(a,b){if(a&&b){return 0;}
if(!a&&!b){return 0;}
else{return a?1:-1}};this.sortDDMMStr=function(a,b){var dateA,dateB,mtch,m,d,y;mtch=a.match(dateRE);y=mtch[3];m=mtch[2];d=mtch[1];if(m.length==1)m='0'+m;if(d.length==1)d='0'+d;dateA=y+m+d;mtch=b.match(dateRE);y=mtch[3];m=mtch[2];d=mtch[1];if(m.length==1)m='0'+m;if(d.length==1)d='0'+d;dateB=y+m+d;if(dateA==dateB)return 0;if(dateA<dateB)return-1;return 1;};this.sortMMDDStr=function(a,b){var dateA,dateB,mtch,m,d,y;mtch=a.match(dateRE);y=mtch[3];d=mtch[2];m=mtch[1];if(m.length==1)m='0'+m;if(d.length==1)d='0'+d;dateA=y+m+d;mtch=b.match(dateRE);y=mtch[3];d=mtch[2];m=mtch[1];if(m.length==1)m='0'+m;if(d.length==1)d='0'+d;dateB=y+m+d;if(dateA==dateB)return 0;if(dateA<dateB)return-1;return 1;};this.sort=function(col,direction){if(col===prevSortInfo.column&&direction===prevSortInfo.direction){return;}
self.sortInfo({column:col,direction:direction});};this.sortData=function(){var data=dataSource(),sortInfo=self.sortInfo(),col,direction,sortFn,item,propPath,prop,i;if(!data||!sortInfo||options.useExternalSorting){internalSortedData(data);return;}
col=sortInfo.column;direction=sortInfo.direction;if(colSortFnCache[col.field]){sortFn=colSortFnCache[col.field];}else{item=dataSource()[0];if(item){propPath=col.field.split(".");prop=item;for(i=0;i<propPath.length&&prop!==undefined&&prop!==null;i++){prop=ko.utils.unwrapObservable(prop[propPath[i]]);}}
sortFn=self.guessSortFn(prop);if(sortFn){colSortFnCache[col.field]=sortFn;}else{sortFn=self.sortAlpha;}}
data.sort(function(itemA,itemB){var propA=itemA,propB=itemB,propAEmpty=false,propBEmpty=false,propPath,i;propPath=col.field.split(".");for(i=0;i<propPath.length;i++){if(propA!==undefined&&propA!==null){propA=ko.utils.unwrapObservable(propA[propPath[i]]);}
if(propB!==undefined&&propB!==null){propB=ko.utils.unwrapObservable(propB[propPath[i]]);}}
propAEmpty=self.isEmpty(propA);propBEmpty=self.isEmpty(propB);if(propAEmpty&&propBEmpty){return 0;}else if(propAEmpty){return 1;}else if(propBEmpty){return-1;}
if(direction===ASC){return sortFn(propA,propB);}else{return 0-sortFn(propA,propB);}});internalSortedData(data);};dataSource.subscribe(self.sortData);this.sortInfo.subscribe(self.sortData);initPhase=1;};﻿
kg.SelectionManager=function(options,rowManager){var self=this,isMulti=options.isMulti,dataSource=options.data,KEY='__kg_selected__',maxRows=ko.computed(function(){return dataSource().length;});this.selectedItems=options.selectedItems;this.selectedIndex=options.selectedIndex;this.lastClickedRow=options.lastClickedRow;this.changeSelection=function(rowItem,clickEvent){if(isMulti&&clickEvent.shiftKey){if(self.lastClickedRow()){var thisIndx=rowManager.rowCache.indexOf(rowItem);var prevIndex=rowManager.rowCache.indexOf(self.lastClickedRow());if(thisIndx<prevIndex){thisIndx=thisIndx^prevIndex;prevIndex=thisIndx^prevIndex;thisIndx=thisIndx^prevIndex;}
for(;prevIndex<=thisIndx;prevIndex++){rowManager.rowCache[prevIndex].selected(true);if(self.selectedItems.indexOf(rowManager.rowCache[prevIndex].entity())===-1){self.selectedItems.push(rowManager.rowCache[prevIndex].entity());}}}
document.getSelection().removeAllRanges();}else if(isMulti&&clickEvent.ctrlKey){self.toggle(rowItem);document.getSelection().removeAllRanges();}else{utils.forEach(self.selectedItems(),function(item){item.myRowEntity.selected(false);});self.selectedItems.removeAll();self.toggle(rowItem);}
self.lastClickedRow(rowItem);return true;}
this.toggle=function(item){if(item.selected()){item.selected(false);self.selectedItems.remove(item.entity());}else{item.selected(true);if(self.selectedItems.indexOf(item.entity())===-1){self.selectedItems.push(item.entity());}}};this.selectedItemCount=ko.computed(function(){return self.selectedItems().length;});this.selectedItems.subscribe(function(newItems){var data=dataSource();if(!newItems){newItems=[];}
utils.forEach(data,function(item,i){if(!item[KEY]){item[KEY]=ko.observable(false);}
if(ko.utils.arrayIndexOf(newItems,item)>-1){item[KEY](true);}else{item[KEY](false);}});});this.lastSelectedItem=options.lastClickedRow;this.toggleSelectAll=ko.computed({read:function(){var cnt=self.selectedItemCount();if(maxRows()===0){return false;}
return cnt===maxRows();},write:function(val){var checkAll=val,dataSourceCopy=[];utils.forEach(dataSource(),function(item){dataSourceCopy.push(item);});if(checkAll){self.selectedItems(dataSourceCopy);}else{self.selectedItems([]);}}});dataSource.subscribe(function(items){var selectedItems,itemsToRemove;if(!items){return;}
selectedItems=self.selectedItems();itemsToRemove=[];ko.utils.arrayForEach(selectedItems,function(item){if(ko.utils.arrayIndexOf(items,item)<0){itemsToRemove.push(item);}});if(itemsToRemove.length>0){self.selectedItems.removeAll(itemsToRemove);}});};﻿kg.gridManager=(new function(){var self=this,elementGridKey='__koGrid__';this.gridCache={};this.storeGrid=function(element,grid){self.gridCache[grid.gridId]=grid;element[elementGridKey]=grid.gridId;if(element.tabIndex==-1){element.tabIndex=self.getIndexOfCache(grid.gridId);}};this.removeGrid=function(gridId){delete self.gridCache[gridId];};this.getGrid=function(element){var grid;if(element[elementGridKey]){grid=self.gridCache[element[elementGridKey]];}
return grid;};this.clearGridCache=function(){self.gridCache={};};this.getIndexOfCache=function(gridId){var indx=-1;for(var grid in self.gridCache){indx++;if(!self.gridCache.hasOwnProperty(grid))continue;return indx;}
return indx;﻿};this.assignGridEventHandlers=function(grid){grid.$viewport.scroll(function(e){var scrollLeft=e.target.scrollLeft,scrollTop=e.target.scrollTop;grid.adjustScrollLeft(scrollLeft);grid.adjustScrollTop(scrollTop);});var $parent=grid.$root.parent();if($parent.length==0){$parent=grid.$root;}
$(window).resize(function(){var prevSizes={rootMaxH:grid.elementDims.rootMaxH,rootMaxW:grid.elementDims.rootMaxW,rootMinH:grid.elementDims.rootMinH,rootMinW:grid.elementDims.rootMinW},scrollTop=0,isDifferent=false;var $hiddens=grid.$root.parents(":hidden");if($hiddens.length>0){return;}
scrollTop=grid.$viewport.scrollTop();kg.domUtility.measureGrid(grid.$root,grid);if(prevSizes.rootMaxH!==grid.elementDims.rootMaxH&&grid.elementDims.rootMaxH!==0){isDifferent=true;}else if(prevSizes.rootMaxW!==grid.elementDims.rootMaxW&&grid.elementDims.rootMaxW!==0){isDifferent=true;}else if(prevSizes.rootMinH!==grid.elementDims.rootMinH){isDifferent=true;}else if(prevSizes.rootMinW!==grid.elementDims.rootMinW){isDifferent=true;}else{return;}
if(isDifferent){grid.refreshDomSizes();grid.adjustScrollTop(scrollTop,true);}});};}());﻿
kg.KoGrid=function(options){var defaults={rowHeight:30,columnWidth:100,headerRowHeight:30,footerRowHeight:55,filterRowHeight:30,rowTemplate:'kgRowTemplate',headerTemplate:'kgHeaderRowTemplate',headerCellTemplate:'kgHeaderCellTemplate',footerTemplate:'kgFooterTemplate',footerVisible:ko.observable(true),canSelectRows:true,autogenerateColumns:true,data:null,columnDefs:ko.observableArray([]),pageSizes:[250,500,1000],enablePaging:false,pageSize:ko.observable(250),totalServerItems:ko.observable(),currentPage:ko.observable(1),selectedItems:ko.observableArray([]),selectedIndex:ko.observable(0),displaySelectionCheckbox:true,displayRowIndex:true,useExternalFiltering:false,useExternalSorting:false,filterInfo:ko.observable(),sortInfo:ko.observable(),filterWildcard:"*",includeDestroyed:false,selectWithCheckboxOnly:false,keepLastSelectedAround:false,isMultiSelect:true,lastClickedRow:ko.observable()},self=this,filterIsOpen=ko.observable(false),filterManager,sortManager,isSorting=false,prevScrollTop,prevScrollLeft,prevMinRowsToRender,maxCanvasHt=0,h_updateTimeout;this.$root;this.$topPanel;this.$headerContainer;this.$headerScroller;this.$headers;this.$viewport;this.$canvas;this.$footerPanel;this.selectionManager;this.selectedItemCount;if(options.columnDefs&&!ko.isObservable(options.columnDefs)){var observableColumnDefs=ko.observableArray(options.columnDefs);options.columnDefs=observableColumnDefs;}
this.config=$.extend(defaults,options);this.gridId="kg"+kg.utils.newId();this.initPhase=0;if(this.config.footerRowHeight===defaults.footerRowHeight&&!this.config.canSelectRows){defaults.footerRowHeight=30;this.config.footerRowHeight=30;}
this.data=self.config.data;filterManager=new kg.FilterManager(self.config);sortManager=new kg.SortManager({data:filterManager.filteredData,sortInfo:self.config.sortInfo,useExternalSorting:self.config.useExternalFiltering});this.sortInfo=sortManager.sortInfo;this.filterInfo=filterManager.filterInfo;this.finalData=sortManager.sortedData;this.canvasHeight=ko.observable(maxCanvasHt.toString()+'px');this.maxRows=ko.computed(function(){var rows=self.finalData();maxCanvasHt=rows.length*self.config.rowHeight;self.canvasHeight(maxCanvasHt.toString()+'px');return rows.length||0;});this.maxCanvasHeight=function(){return maxCanvasHt||0;};this.columns=new kg.ColumnCollection();this.rowManager;this.rows;this.headerRow;this.footer;this.elementDims={scrollW:0,scrollH:0,cellHdiff:0,cellWdiff:0,rowWdiff:0,rowHdiff:0,rowIndexCellW:35,rowSelectedCellW:25,rootMaxW:0,rootMaxH:0,rootMinW:0,rootMinH:0};this.elementsNeedMeasuring=true;this.rootDim=ko.observable(new kg.Dimension({outerHeight:20000,outerWidth:20000}));this.headerDim=ko.computed(function(){var rootDim=self.rootDim(),filterOpen=filterIsOpen(),newDim=new kg.Dimension();newDim.outerHeight=self.config.headerRowHeight;newDim.outerWidth=rootDim.outerWidth;if(filterOpen){newDim.outerHeight+=self.config.filterRowHeight;}
return newDim;});this.footerDim=ko.computed(function(){var rootDim=self.rootDim(),showFooter=self.config.footerVisible(),newDim=new kg.Dimension();newDim.outerHeight=self.config.footerRowHeight;newDim.outerWidth=rootDim.outerWidth;if(!showFooter){newDim.outerHeight=3;}
return newDim;});this.viewportDim=ko.computed(function(){var rootDim=self.rootDim(),headerDim=self.headerDim(),footerDim=self.footerDim(),newDim=new kg.Dimension();newDim.outerHeight=rootDim.outerHeight-headerDim.outerHeight-footerDim.outerHeight;newDim.outerWidth=rootDim.outerWidth;newDim.innerHeight=newDim.outerHeight;newDim.innerWidth=newDim.outerWidth;return newDim;});this.totalRowWidth=ko.computed(function(){var width=0,cols=self.columns();utils.forEach(cols,function(col,i){width+=col.width();});return width;});this.minRowsToRender=ko.computed(function(){var viewportH=self.viewportDim().outerHeight||1;if(filterIsOpen()){return prevMinRowsToRender;};prevMinRowsToRender=Math.floor(viewportH/self.config.rowHeight);return prevMinRowsToRender;});this.headerScrollerDim=ko.computed(function(){var viewportH=self.viewportDim().outerHeight,filterOpen=filterIsOpen(),maxHeight=self.maxCanvasHeight(),vScrollBarIsOpen=(maxHeight>viewportH),hScrollBarIsOpen=(self.viewportDim().outerWidth<self.totalRowWidth())
newDim=new kg.Dimension();newDim.autoFitHeight=true;newDim.outerWidth=self.totalRowWidth();if(vScrollBarIsOpen){newDim.outerWidth+=self.elementDims.scrollW;}
else if((maxHeight-viewportH)<=self.elementDims.scrollH){newDim.outerWidth+=self.elementDims.scrollW;}
return newDim;});this.toggleSelectAll;this.sortData=function(col,dir){isSorting=true;utils.forEach(self.columns(),function(column){if(column.field!==col.field){if(column.sortDirection()!==""){column.sortDirection("");}}});sortManager.sort(col,dir);isSorting=false;};this.finalData.subscribe(function(){if(self.config.selectedItems()){var lastItemIndex=self.config.selectedItems().length-1;if(lastItemIndex<=0){var item=self.config.selectedItems()[lastItemIndex];if(item){scrollIntoView(item);}}}});var scrollIntoView=function(entity){var itemIndex,viewableRange=self.rowManager.viewableRange();if(entity){itemIndex=ko.utils.arrayIndexOf(self.finalData(),entity);}
if(itemIndex>-1){if(itemIndex>viewableRange.topRow||itemIndex<viewableRange.bottomRow-5){self.rowManager.viewableRange(new kg.Range(itemIndex,itemIndex+self.minRowsToRender()));if(self.$viewport){self.$viewport.scrollTop(itemIndex*self.config.rowHeight);}}};};this.refreshDomSizes=function(){var dim=new kg.Dimension(),oldDim=self.rootDim(),rootH=0,rootW=0,canvasH=0;self.elementsNeedMeasuring=true;rootH=self.maxCanvasHeight()+self.config.headerRowHeight+self.config.footerRowHeight;rootH=Math.min(self.elementDims.rootMaxH,rootH);rootH=Math.max(self.elementDims.rootMinH,rootH);canvasH=rootH-self.config.headerRowHeight-self.config.footerRowHeight;rootW=self.totalRowWidth()+self.elementDims.rowWdiff;if(self.maxCanvasHeight()>canvasH){rootW+=self.elementDims.scrollW||0;}
dim.outerWidth=Math.min(self.elementDims.rootMaxW,rootW);dim.outerWidth=Math.max(self.elementDims.rootMinW,dim.outerWidth);dim.outerHeight=rootH;if(dim.outerHeight!==oldDim.outerHeight||dim.outerWidth!==oldDim.outerWidth){self.rootDim(dim);}};this.refreshDomSizesTrigger=ko.computed(function(){var data=self.data();if(h_updateTimeout){if(window.setImmediate){window.clearImmediate(h_updateTimeout);}else{window.clearTimeout(h_updateTimeout);}}
if(self.initPhase>0){if(!filterIsOpen()&&!isSorting){self.refreshDomSizes();kg.cssBuilder.buildStyles(self);if(self.initPhase>0&&self.$root){self.$root.show();}}}});this.buildColumnDefsFromData=function(){if(self.config.columnDefs().length>0){return;}
if(!self.data()||!self.data()[0]){throw'If auto-generating columns, "data" cannot be of null or undefined type!';}
var item;item=self.data()[0];utils.forIn(item,function(prop,propName){if(propName==='__kg_selected__'){return;}
self.config.columnDefs().push({field:propName});});};this.buildColumns=function(){var columnDefs=self.config.columnDefs,cols=[],column;if(self.config.autogenerateColumns){self.buildColumnDefsFromData();}
if(self.config.displaySelectionCheckbox){columnDefs().splice(0,0,{field:'__kg_selected__',width:self.elementDims.rowSelectedCellW});}
if(self.config.displayRowIndex){columnDefs().splice(0,0,{field:'rowIndex',width:self.elementDims.rowIndexCellW});}
var createColumnSortClosure=function(col){return function(dir){if(dir){self.sortData(col,dir);}}}
if(columnDefs().length>0){utils.forEach(columnDefs(),function(colDef,i){column=new kg.Column(colDef);column.index=i;column.sortDirection.subscribe(createColumnSortClosure(column));column.filter.subscribe(filterManager.createFilterChangeCallback(column));cols.push(column);});self.columns(cols);}};this.init=function(){self.buildColumns();if(self.config.rowTemplate==='kgRowTemplate'){self.config.rowTemplate=self.gridId+self.config.rowTemplate;}
if(self.config.headerTemplate==='kgHeaderRowTemplate'){self.config.headerTemplate=self.gridId+self.config.headerTemplate;}
self.rowManager=new kg.RowManager(self);self.selectionManager=new kg.SelectionManager({isMultiSelect:self.config.isMultiSelect,data:self.finalData,selectedItem:self.config.selectedItem,selectedItems:self.config.selectedItems,selectedIndex:self.config.selectedIndex,lastClickedRow:self.config.lastClickedRow,isMulti:self.config.isMultiSelect},self.rowManager);self.selectedItemCount=self.selectionManager.selectedItemCount;self.toggleSelectAll=self.selectionManager.toggleSelectAll;self.rows=self.rowManager.rows;kg.cssBuilder.buildStyles(self);self.initPhase=1;};this.update=function(){var updater=function(){self.refreshDomSizes();kg.cssBuilder.buildStyles(self);if(self.initPhase>0&&self.$root){self.$root.show();}};if(window.setImmediate){h_updateTimeout=setImmediate(updater);}else{h_updateTimeout=setTimeout(updater,0);}};this.showFilter_Click=function(){var isOpen=(filterIsOpen()?false:true);self.headerRow.filterVisible(isOpen);filterIsOpen(isOpen);};this.clearFilter_Click=function(){utils.forEach(self.columns(),function(col,i){col.filter(null);});};this.adjustScrollTop=function(scrollTop,force){var rowIndex;if(prevScrollTop===scrollTop&&!force){return;}
rowIndex=Math.floor(scrollTop/self.config.rowHeight);prevScrollTop=scrollTop;self.rowManager.viewableRange(new kg.Range(rowIndex,rowIndex+self.minRowsToRender()));};this.adjustScrollLeft=function(scrollLeft){if(self.$headerContainer){self.$headerContainer.scrollLeft(scrollLeft);}};self.init();};﻿
kg.cssBuilder={buildStyles:function(grid){var rowHeight=(grid.config.rowHeight-grid.elementDims.rowHdiff),headerRowHeight=grid.config.headerRowHeight,$style=grid.$styleSheet,gridId=grid.gridId,rules,i=0,len=grid.columns().length,css=new kg.utils.StringBuilder(),col,sumWidth=0,colWidth;if(!$style){$style=$("<style type='text/css' rel='stylesheet' />").appendTo($('head'));}
$style.empty();css.append(".{0} .kgCanvas { width: {1}px; }",gridId,grid.totalRowWidth());css.append(".{0} .kgCell { height: {1}px; }",gridId,rowHeight);css.append(".{0} .kgRow { position: absolute; left: 0; right: 0; height: {1}px; line-height: {1}px; display: inline; }",gridId,rowHeight);css.append(".{0} .kgHeaderCell { top: 0; bottom: 0; }",gridId,headerRowHeight);css.append(".{0} .kgHeaderScroller { line-height: {1}px; overflow: none; }",gridId,headerRowHeight);for(;i<len;i++){col=grid.columns()[i];colWidth=col.width()-grid.elementDims.cellWdiff;css.append(".{0} .col{1} { left: {2}px; right: {3}px; width: {4}px; }",gridId,i,sumWidth,(grid.totalRowWidth()-sumWidth-col.width()),colWidth);sumWidth+=col.width();}
if($style[0].styleSheet){$style[0].styleSheet.cssText=css.toString(" ");}
else{$style[0].appendChild(document.createTextNode(css.toString(" ")));}
grid.$styleSheet=$style;}};﻿kg.domUtility=(new function(){var $testContainer=$('<div></div>'),self=this;var parsePixelString=function(pixelStr){if(!pixelStr){return 0;}
var numStr=pixelStr.replace("/px/gi","");var num=parseInt(numStr,10);return isNaN(num)?0:num;};this.assignGridContainers=function(rootEl,grid){grid.$root=$(rootEl);grid.$topPanel=$(".kgTopPanel",grid.$root[0]);grid.$headerContainer=$(".kgHeaderContainer",grid.$topPanel[0]);grid.$headerScroller=$(".kgHeaderScroller",grid.$headerContainer[0]);grid.$headers=grid.$headerContainer.children();grid.$viewport=$(".kgViewport",grid.$root[0]);grid.$canvas=$(".kgCanvas",grid.$viewport[0]);grid.$footerPanel=$(".kgFooterPanel",grid.$root[0]);};this.measureElementMaxDims=function($container){var dims={};var $test=$("<div style='height: 20000px; width: 20000px;'></div>");$container.append($test);dims.maxWidth=$container.width();dims.maxHeight=$container.height();if(!dims.maxWidth){var pixelStr=$container.css("max-width");dims.maxWidth=parsePixelString(pixelStr);}
if(!dims.maxHeight){var pixelStr=$container.css("max-height");dims.maxHeight=parsePixelString(pixelStr);}
if(dims.maxWidth===0){dims.maxWidth=$container.parent().width();}
if(dims.maxHeight===0){dims.maxHeight=$container.parent().height();}
$test.remove();return dims;};this.measureElementMinDims=function($container){var dims={},$testContainer=$container.clone();$testContainer.appendTo($container.parent().first());dims.minWidth=0;dims.minHeight=0;$testContainer.empty();var $test=$("<div style='height: 0x; width: 0px;'></div>");$testContainer.append($test);dims.minWidth=$testContainer.width();dims.minHeight=$testContainer.height();if(!dims.minWidth){var pixelStr=$testContainer.css("min-width");dims.minWidth=parsePixelString(pixelStr);}
if(!dims.minHeight){var pixelStr=$testContainer.css("min-height");dims.minHeight=parsePixelString(pixelStr);}
$testContainer.remove();return dims;};this.measureGrid=function($container,grid,measureMins){var dims=self.measureElementMaxDims($container);grid.elementDims.rootMaxW=dims.maxWidth;grid.elementDims.rootMaxH=dims.maxHeight;grid.elementDims.scrollW=kg.domUtility.scrollW;grid.elementDims.scrollH=kg.domUtility.scrollH;dims=self.measureElementMinDims($container);grid.elementDims.rootMinW=dims.minWidth;dims.minHeight=Math.max(dims.minHeight,(grid.config.headerRowHeight+grid.config.footerRowHeight+(3*grid.config.rowHeight)));dims.minHeight=Math.min(grid.elementDims.rootMaxH,dims.minHeight);grid.elementDims.rootMinH=dims.minHeight;};this.measureRow=function($canvas,grid){var $row,$cell,isDummyRow,isDummyCell;$row=$canvas.children().first();if($row.length===0){$canvas.append('<div class="kgRow"></div>');$row=$canvas.children().first();isDummyRow=true;}
$cell=$row.children().first();if($cell.length===0){$row.append('<div class="kgCell col0"></div>');$cell=$row.children().first();isDummyCell=true;}
grid.elementDims.rowWdiff=$row.outerWidth()-$row.width();grid.elementDims.rowHdiff=$row.outerHeight()-$row.height();grid.elementDims.cellWdiff=$cell.outerWidth()-$cell.width();grid.elementDims.cellHdiff=$cell.outerHeight()-$cell.height();grid.elementsNeedMeasuring=false;if(isDummyRow){$row.remove();}else if(isDummyCell){$cell.remove();}};this.scrollH=17;this.scrollW=17;this.letterW=5;$(function(){$testContainer.appendTo('body');$testContainer.height(100).width(100).css("position","absolute").css("overflow","scroll");$testContainer.append('<div style="height: 400px; width: 400px;"></div>');self.scrollH=($testContainer.height()-$testContainer[0].clientHeight);self.scrollW=($testContainer.width()-$testContainer[0].clientWidth);$testContainer.empty();$testContainer.attr('style','');$testContainer.append('<span style="font-family: Verdana, Helvetica, Sans-Serif; font-size: 14px;"><strong>M</strong></span>');self.letterW=$testContainer.children().first().width();$testContainer.remove();});}());﻿
ko.bindingHandlers['kgWith']=(function(){return{init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var val=ko.utils.unwrapObservable(valueAccessor()),newContext=bindingContext.createChildContext(val);if(!val){throw Error("Cannot use a null or undefined value with the 'kgWith' binding");}
ko.applyBindingsToDescendants(newContext,element);return{'controlsDescendantBindings':true};}};}());﻿
ko.bindingHandlers['koGrid']=(function(){var makeNewValueAccessor=function(grid){return function(){return{name:GRID_TEMPLATE,data:grid};};};return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid,options=valueAccessor(),$element=$(element);var grid=kg.gridManager.getGrid(element);if(!grid){grid=new kg.KoGrid(options);kg.gridManager.storeGrid(element,grid);}else{return false;}
kg.templateManager.ensureGridTemplates({rowTemplate:grid.config.rowTemplate,headerTemplate:grid.config.headerTemplate,headerCellTemplate:grid.config.headerCellTemplate,footerTemplate:grid.config.footerTemplate,columns:grid.columns(),showFilter:grid.config.allowFiltering});grid.config.columnDefs.subscribe(function(){var oldgrid=kg.gridManager.getGrid(element);var oldgridId=oldgrid.gridId.toString();$(element).empty();$(element).removeClass("kgGrid").removeClass("ui-widget").removeClass(oldgridId);kg.gridManager.removeGrid(oldgridId);ko.applyBindings(bindingContext,element);});kg.domUtility.measureGrid($element,grid,true);$element.hide();$(element).addClass("kgGrid").addClass("ui-widget").addClass(grid.gridId.toString());return ko.bindingHandlers['template'].init(element,makeNewValueAccessor(grid),allBindingsAccessor,grid,bindingContext);},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid,returnVal;grid=kg.gridManager.getGrid(element);if(!grid){return{'controlsDescendantBindings':true};}
returnVal=ko.bindingHandlers['template'].update(element,makeNewValueAccessor(grid),allBindingsAccessor,grid,bindingContext);kg.domUtility.assignGridContainers(element,grid);kg.gridManager.assignGridEventHandlers(grid);grid.update();return returnVal;}};}());﻿
ko.bindingHandlers['kgRows']=(function(){var RowSubscription=function(){this.rowKey;this.rowIndex;this.node;this.subscription;};var compareRows=function(rows,rowSubscriptions){rowMap={},newRows=[],rowSubscriptionsToRemove=[];ko.utils.arrayForEach(rows,function(row){rowMap[row.rowIndex]=row;var possibleRow=rowSubscriptions[row.rowIndex];if(!possibleRow){newRows.push(row);}else if(possibleRow.rowKey!==row.rowKey){newRows.push(row);}});utils.forIn(rowSubscriptions,function(rowSubscription,index){var compareRow=rowMap[index];if(!compareRow){rowSubscriptionsToRemove.push(rowSubscription);}else if(compareRow.rowKey!==rowSubscription.rowKey){rowSubscriptionsToRemove.push(rowSubscription);}});return{add:newRows,remove:rowSubscriptionsToRemove};};return{init:function(){return{'controlsDescendantBindings':true};},update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var rowManager=bindingContext.$data.rowManager,rows=ko.utils.unwrapObservable(valueAccessor()),grid=bindingContext.$data,rowChanges;rowChanges=compareRows(rows,rowManager.rowSubscriptions||{});ko.utils.arrayForEach(rowChanges.remove,function(rowSubscription){if(rowSubscription.node){ko.removeNode(rowSubscription.node);}
rowSubscription.subscription.dispose();delete rowManager.rowSubscriptions[rowSubscription.rowIndex];});ko.utils.arrayForEach(rowChanges.add,function(row){var newBindingCtx,rowSubscription,divNode=document.createElement('DIV');newBindingCtx=bindingContext.createChildContext(row);element.appendChild(divNode);rowSubscription=new RowSubscription();rowSubscription.rowKey=row.rowKey;rowSubscription.rowIndex=row.rowIndex;rowManager.rowSubscriptions[row.rowIndex]=rowSubscription;rowSubscription.subscription=ko.renderTemplate(grid.config.rowTemplate,newBindingCtx,null,divNode,'replaceNode');});if(grid.elementsNeedMeasuring&&grid.initPhase>0){kg.domUtility.measureRow($(element),grid);}
return{'controlsDescendantBindings':true};}};}());﻿
ko.bindingHandlers['kgRow']=(function(){return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var row=valueAccessor(),classes='kgRow',grid=bindingContext.$parent,rowManager=bindingContext.$parent.rowManager,rowSubscription;if(grid.config.canSelectRows){classes+=' kgCanSelect';}
classes+=(row.rowIndex%2)===0?' even':' odd';element['_kg_rowIndex_']=row.rowIndex;element.style.top=row.offsetTop+'px';element.className=classes;rowSubscription=rowManager.rowSubscriptions[row.rowIndex];if(rowSubscription){rowSubscription.node=element;}}};}());﻿
ko.bindingHandlers['kgCell']=(function(){var makeValueAccessor=function(cell){var func;if(cell.column.field==='rowIndex'){return function(){return cell.row.rowDisplayIndex;}}else{return function(){return cell.data;}}};return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var options=valueAccessor(),cell,row=bindingContext.$data;cell=row.cellMap[options.value];if(cell==undefined)return;element.className+=" kgCell "+"col"+cell.column.index+" ";if(cell.column.field!=='__kg_selected__'&&!cell.column.hasCellTemplate){ko.bindingHandlers.text.update(element,makeValueAccessor(cell));}}};}());﻿ko.bindingHandlers['kgHeaderRow']=(function(){var buildHeaders=function(grid){var cols=grid.columns(),cell,headerRow=new kg.HeaderRow();utils.forEach(cols,function(col,i){cell=new kg.HeaderCell(col);cell.colIndex=i;headerRow.headerCells.push(cell);headerRow.headerCellMap[col.field]=cell;});grid.headerRow=headerRow;grid.headerRow.height=grid.config.headerRowHeight;};var makeNewValueAccessor=function(grid){return function(){return{name:grid.config.headerTemplate,data:grid.headerRow};}};return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=bindingContext.$data;buildHeaders(grid);return ko.bindingHandlers.template.init(element,makeNewValueAccessor(grid),allBindingsAccessor,grid,bindingContext);},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=bindingContext.$data;return ko.bindingHandlers.template.update(element,makeNewValueAccessor(grid),allBindingsAccessor,grid,bindingContext);}}}());﻿ko.bindingHandlers['kgHeader']=(function(){var makeNewValueAccessor=function(headerCell,grid){return function(){return{name:headerCell.headerTemplate||grid.config.headerCellTemplate,data:headerCell};};};return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var headerRow=bindingContext.$data,cell,property,options=valueAccessor();if(options){property=options.value;cell=headerRow.headerCellMap[property];if(cell){if(property!=='rowIndex'&&property!=='__kg_selected__'){return{'controlsDescendantBindings':true}}}}},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var headerRow=bindingContext.$data,grid=bindingContext.$parent,cell,property,options=valueAccessor();if(options){property=options.value;cell=headerRow.headerCellMap[property];if(cell){element.className+=" kgHeaderCell col"+cell.colIndex+" ";if(cell.headerClass){element.className+=" "+cell.headerClass;}
if(property!=='rowIndex'&&property!=='__kg_selected__'){return ko.bindingHandlers.template.update(element,makeNewValueAccessor(cell,grid),allBindingsAccessor,viewModel,bindingContext);}}}}}}());﻿ko.bindingHandlers['kgFooter']=(function(){var makeNewValueAccessor=function(grid){return function(){return{name:grid.config.footerTemplate,data:grid.footer};}};var makeNewBindingContext=function(bindingContext,footer){return bindingContext.createChildContext(footer);};return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=bindingContext.$data;grid.footer=new kg.Footer(grid);return ko.bindingHandlers.template.init(element,makeNewValueAccessor(grid),allBindingsAccessor,grid,makeNewBindingContext(bindingContext,grid.footer));},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=bindingContext.$data;return ko.bindingHandlers.template.update(element,makeNewValueAccessor(grid),allBindingsAccessor,grid,makeNewBindingContext(bindingContext,grid.footer));}}}());﻿ko.bindingHandlers['kgSize']=(function(){return{'init':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){},'update':function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var $container=$(element),$parent=$container.parent(),dim=ko.utils.unwrapObservable(valueAccessor()),oldHt=$container.outerHeight(),oldWdth=$container.outerWidth();if(dim!=undefined){if(dim.autoFitHeight){dim.outerHeight=$parent.height();}
if(dim.innerHeight&&dim.innerWidth){$container.height(dim.innerHeight);$container.width(dim.innerWidth);return;};if(oldHt!==dim.outerHeight||oldWdth!==dim.outerWidth){$container.height(dim.outerHeight).width(dim.outerWidth);oldHt=$container.outerHeight();oldWdth=$container.outerWidth();dim.heightDiff=oldHt-$container.height();dim.widthDiff=oldWdth-$container.width();$container.height(dim.outerHeight-dim.heightDiff);$container.width(dim.outerWidth-dim.widthDiff);}}}};}());}(window));